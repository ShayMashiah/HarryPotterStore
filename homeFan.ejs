<%- include('layout.ejs'); %>

    <% if ( user == null || user.role != "fan" ) { %>
        <%- include('login.ejs') %> 
    <% }  
    else 
    {  %>  
    
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=places&key=<%= google_maps_api_key %>" ></script>        
    <input type="hidden" id="user_id" value="<%=user.id %>" ></input> 
    <input type="hidden" id="user_name" value="<%=user.name %>" ></input>
    
    <aside style="position: fixed; overflow-y: auto; bottom: 60px; right: 0; top:0; ">
        <a href="/logout">
            <button type="submit" class="btn btn-primary btn-lg btn-block login-button">Logout</button> 
        </a>
        <hr>
        <form action="/filterCollectionNameProductTable" method="POST">
            <div style="margin: 5px">
                <button type="submit" class="btn btn-warning btn-lg">Filter by collectionName</button>             
            </div>
            <div style="margin: 5px">
                <select name="filter_collectionName" class="form-control">
                    <option >Select collectionName</option>
                <%
                if ( productData.length != 0 ) {
                    var collectionNames = [ ...new Set ( productData.map ( item => item.collectionName) ) ]
                    collectionNames.forEach ( function ( collectionName ) {
                %>
                    <option value="<%=collectionName %>"><%=collectionName %></option>
                <% } )
                } %>
                </select>   
            </div>                     
        </form>
       
        <form action="/filterCharacterProductTable" method="POST">
            <div style="margin: 5px">
                <button type=""submit" class="btn btn-warning btn-lg" >Filter by character</button> 
            </div>
            <div style="margin: 5px">
                <select name="filter_character" class="form-control">
                    <option >Select character</option>
                <%
                if ( productData.length != 0 ) {
                    var characters = [ ...new Set ( productData.map ( item => item.character ) ) ]
                    characters.forEach ( function ( character ) {
                %>
                    <option value="<%=character %>"><%=character %></option>
                <% })
                } %>
                </select>
            </div>            
        </form>
       
        <form action="/filterPriceProductTable" method="POST">
            <div style="margin: 5px">
                <button type="submit" class="btn btn-warning btn-lg" >Filter by price</button> 
            </div>
            <div style="margin: 5px; display: flex; flex-direction: row;">
                <label style="color: white; width: 50px">From</label>
                <input name="price_from" class="form-control"></input>
            </div>    
            <div style="margin: 5px; display: flex; flex-direction: row;">
                <label style="color: white; width: 50px">To</label>
                <input name="price_to" class="form-control"></input>
            </div>           
        </form>
        
        <div style="margin: 5px">
            <button type="submit" class="btn btn-warning btn-lg" onclick="filterThreeParams()" >Filter by 3 parameters</button> 
        </div>
        <div style="margin: 5px">
            <select id="character" class="form-control">
                <option >Select character</option>    
            <%
                if ( productData.length != 0 ) {
                    var characters = [ ...new Set ( productData.map ( item => item.character ) ) ]
                    characters.forEach ( function ( character ) {
                %>
                <option value="<%=character %>"><%=character %></option>
            <% } )
            } %>
            </select>   
        </div> 
        <div style="margin: 5px">        
            <select id="collectionName" class="form-control">
                <option >Select collectionName</option> 
            <%
                if ( productData.length != 0 ) {
                    var collectionNames = [ ...new Set ( productData.map ( item => item.collectionName ) ) ]
                    collectionNames.forEach ( function ( collectionName ) {
                %>
                <option value="<%=collectionName %>"><%=collectionName %></option>
                <% } )
            } %>
            </select>
        </div> 
        <div style="margin: 5px">   
            <select id="department" class="form-control">
                <option >Select collectionName</option> 
            <%
                if ( productData.length != 0 ) {
                    var departments = [ ...new Set ( productData.map ( item => item.department ) ) ]
                    departments.forEach ( function ( department ) {
            %>
                <option value="<%=department %>"><%=department %></option>
            <% })
            } %>
            </select>
        </div> 
        <div style="margin: 5px">          
        <a href="/clearFilters"> 
            <button type="submit" class="btn btn-warning btn-lg">Clear Filters</button> 
        </a>
        </div> 
        <hr> 
        <button class="btn btn-primary btn-lg button-block login-button" onclick="showOrders(null)">Shopping cart</button>              
    </aside>

    <section id="tableSection">         
        <div style="margin: 20px; height: 600px; width: 1000px; overflow: auto">
        <table id="table-data" class="table-data" border="1" >
            <tr>
                <th>S.N</th>
                <th>Department</th>
                <th>Title</th>
                <th>CollectionName</th>
                <th>Character</th>
                <th>Price</th> <!-- <th>Image</th> -->
                <th>Buy</th>
            </tr>
            
            <%
            if ( productData.length != 0 ) {
                var i=1
                productData.forEach ( function ( data ) {
            %>
            <tr>
                <td ><%=i; %></td>
                <td id="department_<%=i; %>"><%=data.department %></td>
                <td id="title_<%=i; %>"><%=data.title %></td>
                <td id="collectionName_<%=i; %>"><%=data.collectionName %></td>
                <td id="character_<%=i; %>"><%=data.character %></td>
                <td id="price_<%=i; %>"><%=data.price %></td> <!-- <td><img src="<%=data.image %>" width="100px" height="100px"></td> -->
                <td><input type="checkbox" id="order_<%=i; %>"></td>
            </tr>
            <%  i++ }) %>
            <% } else{ %>
                <tr>
                    <td colspan="7">No Data Found</td>
                </tr>
            <% } %>
        </table>
        </div>

        <div style="margin: 5px">
          <button class="transform btn btn-warning btn-lg" onclick="order()">Purchase</button>  
        </div>
    </section>

    <div id="dialog" title="Orders" style="display: none;">
        <table id="shopping_cart" border="1" ></table>
    </div> 
    
    <div id="map" style="width: 200px; height: 200px; "></div>

    <video id="video_popup" style="display: none; width: 360px;" id="videoPlayer" controls muted="muted" autoplay> 
        <source src="/video" type="video/mp4">
        Sorry, your browser doesn't support embedded videos." type="video/mp4">
    </video>

    <% } %>

<style type="text/css" media="screen, print">
    #tableSection {
        position: absolute;
        bottom: 80px;
    }
    header {
        display: none;
    }
</style>  

<script>
           
    function order() {
            $( ".transform" ).addClass( "transform-active" )
            var ordered = []
            var time = Date.now ()
            $( "input:checked" ).each ( function () {
                const index = $( this )[0].id.split( "order_" )[1]
                ordered.push ( {
                    fanId: $("#user_id")[0].value,
                    orderTime: time,
                    department: $("#department_" + index.toString())[0].textContent,
                    title: $("#title_" + index.toString())[0].textContent,
                    collectionName: $("#collectionName_" + index.toString())[0].textContent,
                    character: $("#character_" + index.toString())[0].textContent,
                    price: $("#price_" + index.toString())[0].textContent,                    
                } )
            } ) 
            
            const webMethod = "/order"
            
            $.ajax({
                type: "POST",
                url: webMethod,
                data: JSON.stringify ( { 'orderList': ordered } ),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function ( result ) {
                    $( ".transform" ).removeClass("transform-active");
                    socket.emit( "new order", { order: result, userName: $( "#user_name" )[0].value } )
                },
            } )
        }
       
    function filterThreeParams() {
            const webMethod = "/filterThreeParams"
            
            $.ajax ( {
                type: "POST",
                url: webMethod,
                data: JSON.stringify ( 
                { 
                    'collectionName': $("#collectionName")[0].value, 
                    'character': $("#character")[0].value, 
                    'department': $("#department")[0].value,
                } ),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function ( result ) {
                    $( "#table-data" ).find( "tr:gt(0)" ).remove()
                    var rows = []
                    for ( i = 0; i < result.length; i++ )
                    {
                        var row = $( '<tr/>' )
                        row.append ( $( '<td />' ).html( ( i + 1 ).toString ( ) ) )
                        row.append ( $( '<td id="department_' + i + '"/>' ).html( result[i]["department"] ) ) 
                        row.append ( $( '<td id="title_' + i + '"/>' ).html( result[i]["title"] ) ) 
                        row.append ( $( '<td id="collectionName_' + i + '"/>' ).html( result[i]["collectionName"] ) ) 
                        row.append ( $( '<td id="character_' + i + '"/>' ).html( result[i]["character"] ) ) 
                        row.append ( $( '<td id="price_' + i + '"/>' ).html( result[i]["price"] ) ) 
                        row.append ( $( '<td />' ).html( '<input type="checkbox" id="order_' + i + '">' ) )
                        rows.push( row )
                    }
                    
                    for ( i = 0; i < rows.length; i = i + 1 ) {
                        $( "#table-data" ).append( rows[i] )
                    }
                },
            } )
        }
</script>    